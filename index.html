<!DOCTYPE html>
<html lang="ro">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Liz Inventory V11 - ULTIMATE FIX</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://unpkg.com/@zxing/library@latest"></script>
    <style>
        body { font-family: sans-serif; margin: 0; padding: 10px; background: #f4f7f6; }
        .card { background: white; padding: 15px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); margin-bottom: 10px; }
        .btn { border: none; border-radius: 8px; padding: 15px; font-weight: bold; cursor: pointer; width: 100%; margin-bottom: 10px; }
        .btn-scan { background: #673ab7; color: white; display: flex; align-items: center; justify-content: center; gap: 10px; font-size: 16px; }
        .btn-mic { background: #ea4335; color: white; width: 55px; border-radius: 8px; font-size: 22px; border: none; display: flex; align-items: center; justify-content: center; }
        .btn-blue { background: #1a73e8; color: white; }
        .btn-green { background: #34a853; color: white; position: fixed; bottom: 10px; left: 10px; width: calc(100% - 20px); height: 60px; z-index: 100; box-shadow: 0 -2px 10px rgba(0,0,0,0.2); }
        .area-btn { background: white; border: 1px solid #1a73e8; color: #1a73e8; width: 47%; display: inline-block; font-size: 11px; min-height: 45px; margin: 1%; border-radius: 6px; }
        .active { background: #1a73e8 !important; color: white !important; }
        .search-row { display: flex; gap: 8px; margin: 10px 0; }
        input { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px; font-size: 16px; box-sizing: border-box; }
        #results { margin-top: 15px; padding-bottom: 110px; }
        .item { padding: 15px; background: white; border-radius: 10px; margin-bottom: 8px; border-left: 5px solid #1a73e8; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        .prod-name { font-weight: bold; font-size: 14px; color: #111; display: block; text-align: left; }
        .prod-unit { font-size: 12px; color: #d81b60; font-weight: bold; display: block; margin-top: 4px; }
        #scan-container { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: black; z-index: 2000; display: none; flex-direction: column; }
        video { width: 100%; height: 80%; object-fit: cover; }
    </style>
</head>
<body>

<div id="setup" class="card">
    <h2>Liz Inventory V11</h2>
    <input type="text" id="user" placeholder="Numele tÄƒu">
    <input type="file" id="file" accept=".xlsx" onchange="load(this)">
    <div id="st" style="margin-top:10px; font-weight:bold; color:#34a853;"></div>
    <button id="go" class="btn btn-blue" style="display:none" onclick="openApp()">DESCHIDE LISTA</button>
</div>

<div id="app" style="display:none">
    <button class="btn btn-scan" onclick="startScan()">ðŸ“· SCANARE BARCOD</button>
    <div id="cats" class="card" style="text-align:center"></div>
    <div class="search-row">
        <input type="text" id="q" placeholder="CautÄƒ produs..." oninput="draw()">
        <button class="btn-mic" onclick="runVoice()">ðŸŽ¤</button>
    </div>
    <div id="list"></div>
</div>

<div id="scan-container">
    <video id="video"></video>
    <button class="btn" style="background:red; color:white;" onclick="stopScan()">ÃŽNCHIDE</button>
</div>

<button id="dl" class="btn btn-green" style="display:none" onclick="save()">ðŸ’¾ DESCARCÄ‚ EXCEL FINAL</button>

<script>
let db = []; let log = {}; let cur = "";
const reader = new ZXing.BrowserMultiFormatReader();

function load(input) {
    const fr = new FileReader();
    fr.onload = (e) => {
        const wb = XLSX.read(new Uint8Array(e.target.result), {type: 'array'});
        db = [];
        const cats = document.getElementById('cats');
        cats.innerHTML = "";
        
        wb.SheetNames.forEach(sh => {
            if(sh.toLowerCase().includes("summary")) return;
            let b = document.createElement('button'); b.className = 'area-btn'; b.innerText = sh;
            b.onclick = () => { document.querySelectorAll('.area-btn').forEach(x => x.classList.remove('active')); b.classList.add('active'); cur = sh; draw(); };
            cats.appendChild(b);

            let rows = XLSX.utils.sheet_to_json(wb.Sheets[sh], {header: 1});
            rows.forEach(r => {
                let cells = r.map(v => String(v || "").trim());
                let unit = cells.find(c => ["each", "case", "unit", "pack", "bag", "kg", "box"].includes(c.toLowerCase())) || "";
                let name = cells.reduce((a, b) => {
                    let isU = ["each", "case", "unit", "pack", "bag", "kg", "box"].includes(b.toLowerCase());
                    let isC = /^\d+$/.test(b) && b.length > 4;
                    return (!isU && !isC && b.length > a.length && b.length < 100) ? b : a;
                }, "");
                let code = cells[1] || cells[0] || "";
                if(name.length > 2) db.push({ n: name, u: unit, c: code, a: sh });
            });
        });
        document.getElementById('st').innerText = "âœ… " + db.length + " produse Ã®ncÄƒrcate!";
        document.getElementById('go').style.display = "block";
    };
    fr.readAsArrayBuffer(input.files[0]);
}

function openApp() {
    if(!document.getElementById('user').value) return alert("Nume?");
    document.getElementById('setup').style.display = 'none';
    document.getElementById('app').style.display = 'block';
    document.getElementById('dl').style.display = 'block';
}

function draw() {
    let s = document.getElementById('q').value.toLowerCase();
    let filtered = db.filter(x => x.a === cur && x.n.toLowerCase().includes(s));
    document.getElementById('list').innerHTML = filtered.map(i => `
        <div class="item" onclick="add('${i.n.replace(/'/g, "\\'")}', '${i.u}')">
            <div style="text-align:left">
                <span class="prod-name">${i.n}</span>
                <span class="prod-unit">${i.u ? 'Unitate: ' + i.u : 'FÄƒrÄƒ unitate specificatÄƒ'}</span>
            </div>
            <b style="color:#1a73e8; font-size:20px">${log[i.n + i.u] || '+'}</b>
        </div>
    `).join('');
}

function add(n, u) {
    let k = n + u;
    let v = prompt("Cantitate pentru:\n" + n + "\n(" + (u || "Each") + ")");
    if(v !== null && !isNaN(v) && v !== "") { log[k] = (log[k] || 0) + parseFloat(v); draw(); }
}

function startScan() {
    document.getElementById('scan-container').style.display = "flex";
    reader.decodeFromVideoDevice(null, 'video', (res) => {
        if (res) {
            stopScan();
            let f = db.find(x => x.c == res.text);
            if(f) { cur = f.a; draw(); add(f.n, f.u); } else alert("Cod necunoscut: " + res.text);
        }
    });
}
function stopScan() { reader.reset(); document.getElementById('scan-container').style.display = "none"; }

function runVoice() {
    const sr = new (window.SpeechRecognition || window.webkitSpeechRecognition)();
    sr.lang = 'en-US';
    sr.onresult = (e) => { document.getElementById('q').value = e.results[0][0].transcript; draw(); };
    sr.start();
}

function save() {
    const u = document.getElementById('user').value;
    const data = Object.keys(log).map(k => {
        let it = db.find(m => (m.n + m.u) === k);
        return { Personal: u, Zona: it.a, Produs: it.n, Unitate: it.u, Cantitate: log[k] };
    });
    const ws = XLSX.utils.json_to_sheet(data);
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, "Inventar");
    XLSX.writeFile(wb, `Inventar_${u}.xlsx`);
}
</script>
</body>
</html>
