<!DOCTYPE html>
<html lang="ro">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Liz Stock Take - Ultra Fast</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        body { font-family: -apple-system, sans-serif; margin: 0; padding: 15px; background: #f0f2f5; }
        .card { background: white; padding: 15px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); margin-bottom: 15px; }
        .btn { border: none; border-radius: 8px; padding: 12px; font-weight: bold; width: 100%; cursor: pointer; margin-bottom: 10px; font-size: 14px; }
        .btn-blue { background: #1a73e8; color: white; }
        .btn-green { background: #34a853; color: white; }
        .btn-area { background: #ffffff; border: 2px solid #1a73e8; color: #1a73e8; margin-bottom: 5px; width: 48%; display: inline-block; }
        .area-active { background: #1a73e8 !important; color: white !important; }
        input, select { width: 100%; padding: 12px; margin: 8px 0; border: 1px solid #ddd; border-radius: 8px; font-size: 16px; box-sizing: border-box; }
        #results { max-height: 250px; overflow-y: auto; border: 1px solid #eee; margin-top: 5px; }
        .res-item { padding: 12px; border-bottom: 1px solid #eee; font-size: 14px; display: flex; justify-content: space-between; align-items: center; }
        .qty-badge { background: #e8f0fe; color: #1a73e8; padding: 4px 8px; border-radius: 5px; font-weight: bold; }
    </style>
</head>
<body>

    <div id="setup" class="card">
        <h3>1. ÃŽncarcÄƒ FiÈ™ierul Master</h3>
        <input type="file" id="fileInput" accept=".xlsx" onchange="initApp(this)">
        <input type="text" id="worker" placeholder="Numele tÄƒu">
        <select id="loc">
            <option value="">-- Unde numeri acum? --</option>
            <option value="MAIN KITCHEN">Main Kitchen</option>
            <option value="MILLS">Mills</option>
            <option value="SOUTH">South</option>
            <option value="ROSE & BALL">Rose & Ball</option>
            <option value="CANTEEN">Canteen</option>
        </select>
        <button id="startBtn" class="btn btn-blue" style="display:none;" onclick="startWork()">ÃŽNCEPE STOCUL</button>
    </div>

    <div id="app" style="display:none;">
        <div class="card">
            <h3>2. Alege Aria (Rapid)</h3>
            <div id="areaButtons"></div>
            <input type="text" id="search" placeholder="Sau cautÄƒ produs..." oninput="search()">
            <div id="results"></div>
        </div>

        <div id="entry" class="card" style="display:none; border: 2px solid #1a73e8;">
            <p id="targetProd" style="font-weight:bold; margin:0;"></p>
            <small id="targetInfo" style="color:#666;"></small>
            <input type="number" id="qty" placeholder="Introdu Cantitatea" inputmode="decimal">
            <button class="btn btn-blue" onclick="save()">SALVEAZÄ‚</button>
            <button class="btn" style="background:#eee" onclick="closeEntry()">AnuleazÄƒ</button>
        </div>

        <button class="btn btn-green" style="position:fixed; bottom:10px; left:15px; width:calc(100% - 30px); z-index:100;" onclick="finish()">ðŸ’¾ SALVEAZÄ‚ EXCEL & TRIMITE</button>
    </div>

<script>
    let masterData = [];
    let inventoryLogs = [];
    let selectedProd = null;
    let currentArea = "";

    function initApp(input) {
        const reader = new FileReader();
        reader.onload = (e) => {
            const wb = XLSX.read(new Uint8Array(e.target.result), {type: 'array'});
            masterData = [];
            const areaBtnContainer = document.getElementById('areaButtons');
            areaBtnContainer.innerHTML = "";

            wb.SheetNames.forEach(name => {
                if(name.includes("Summary")) return;
                
                // GenerÄƒm butoane pentru fiecare foaie (Arie) din Excel
                let btn = document.createElement('button');
                btn.className = 'btn btn-area';
                btn.innerText = name;
                btn.onclick = () => filterByArea(name, btn);
                areaBtnContainer.appendChild(btn);

                let rows = XLSX.utils.sheet_to_json(wb.Sheets[name], {defval: ""});
                rows.forEach(r => {
                    if(r["PRODUCT"]) masterData.push({
                        code: r["PRODUCT CODE"] || "N/A",
                        name: r["PRODUCT"],
                        area: name
                    });
                });
            });
            document.getElementById('startBtn').style.display = 'block';
            alert("Excel Ã®ncÄƒrcat! Butoanele pentru arii au fost create.");
        };
        reader.readAsArrayBuffer(input.files[0]);
    }

    function startWork() {
        if(!document.getElementById('loc').value) return alert("Alege locaÈ›ia!");
        document.getElementById('setup').style.display = 'none';
        document.getElementById('app').style.display = 'block';
    }

    function filterByArea(areaName, btnElement) {
        currentArea = areaName;
        document.querySelectorAll('.btn-area').forEach(b => b.classList.remove('area-active'));
        btnElement.classList.add('area-active');
        
        const hits = masterData.filter(p => p.area === areaName);
        displayResults(hits);
    }

    function search() {
        let term = document.getElementById('search').value.toLowerCase();
        if(term.length < 2) return;
        const hits = masterData.filter(p => p.name.toLowerCase().includes(term));
        displayResults(hits);
    }

    function displayResults(items) {
        let div = document.getElementById('results');
        div.innerHTML = items.map(p => `
            <div class="res-item" onclick="openEntry('${p.code}','${p.name.replace(/'/g,"")}','${p.area}')">
                <span><b>${p.name}</b><br><small>${p.area}</small></span>
                <span class="qty-badge">+</span>
            </div>
        `).join('');
    }

    function openEntry(code, name, area) {
        selectedProd = { code, name, area };
        document.getElementById('targetProd').innerText = name;
        document.getElementById('targetInfo').innerText = "Aria: " + area + " | Cod: " + code;
        document.getElementById('entry').style.display = 'block';
        document.getElementById('qty').focus();
    }

    function save() {
        let q = document.getElementById('qty').value;
        if(!q) return;
        inventoryLogs.push({
            Operator: document.getElementById('worker').value,
            Locatie_Fizica: document.getElementById('loc').value,
            Arie_Excel: selectedProd.area,
            Cod_Produs: selectedProd.code,
            Nume_Produs: selectedProd.name,
            Cantitate: q,
            Ora: new Date().toLocaleTimeString()
        });
        closeEntry();
        alert("Salvat: " + q + " x " + selectedProd.name);
    }

    function closeEntry() {
        document.getElementById('entry').style.display = 'none';
        document.getElementById('qty').value = "";
    }

    function finish() {
        if(inventoryLogs.length === 0) return alert("Nu ai date de salvat!");
        
        // Cream un nou fisier Excel
        const ws = XLSX.utils.json_to_sheet(inventoryLogs);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, "Stoc Final");
        
        // Generam fisierul
        const wbout = XLSX.write(wb, {bookType:'xlsx', type:'binary'});
        function s2ab(s) {
            const buf = new ArrayBuffer(s.length);
            const view = new Uint8Array(buf);
            for (let i=0; i<s.length; i++) view[i] = s.charCodeAt(i) & 0xFF;
            return buf;
        }

        const blob = new Blob([s2ab(wbout)], {type:"application/octet-stream"});
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = "Stoc_" + document.getElementById('worker').value + ".xlsx";
        a.click();
        
        alert("FiÈ™ierul Excel a fost descÄƒrcat. Acum Ã®l poÈ›i trimite pe WhatsApp cÄƒtre Liz!");
    }
</script>
</body>
</html>
