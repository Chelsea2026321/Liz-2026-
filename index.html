<!DOCTYPE html>
<html lang="ro">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Liz Stock Take - FIX FINAL</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        body { font-family: sans-serif; margin: 0; padding: 15px; background: #f0f2f5; }
        .card { background: white; padding: 15px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); margin-bottom: 15px; }
        .btn { border: none; border-radius: 8px; padding: 12px; font-weight: bold; width: 100%; cursor: pointer; margin-bottom: 10px; }
        .btn-blue { background: #1a73e8; color: white; }
        .btn-green { background: #34a853; color: white; }
        .btn-area { background: #ffffff; border: 1px solid #1a73e8; color: #1a73e8; margin-bottom: 5px; width: 48%; display: inline-block; box-sizing: border-box; font-size: 12px; min-height: 45px; vertical-align: top; }
        .area-active { background: #1a73e8 !important; color: white !important; }
        input, select { width: 100%; padding: 12px; margin: 8px 0; border: 1px solid #ddd; border-radius: 8px; font-size: 16px; box-sizing: border-box; }
        #results { max-height: 400px; overflow-y: auto; border-top: 3px solid #1a73e8; margin-top: 10px; padding-top: 10px; }
        .res-item { padding: 15px; border-bottom: 1px solid #eee; background: #fff; display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px; border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.05); }
        #entry-popup { position: fixed; top: 15%; left: 5%; width: 90%; z-index: 9999; background: white; padding: 20px; border-radius: 15px; box-shadow: 0 0 30px rgba(0,0,0,0.3); border: 2px solid #1a73e8; }
        .overlay { position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:9998; display:none; }
    </style>
</head>
<body>

    <div id="setup" class="card">
        <h3>1. ÃŽncarcÄƒ FiÈ™ierul</h3>
        <input type="file" id="fileInput" accept=".xlsx" onchange="processExcel(this)">
        <select id="loc">
            <option value="MAIN KITCHEN">Main Kitchen</option>
            <option value="MILLS">Mills</option>
            <option value="SOUTH">South</option>
            <option value="ROSE & BALL">Rose & Ball</option>
            <option value="CANTEEN">Canteen</option>
        </select>
        <button id="startBtn" class="btn btn-blue" style="display:none;" onclick="showApp()">ÃŽNCEPE MUNCÄ‚</button>
    </div>

    <div id="app" style="display:none;">
        <div class="card">
            <div id="areaButtons"></div>
            <input type="text" id="search" placeholder="CautÄƒ produs (ex: Mustard)..." oninput="manualSearch()">
            <div id="results"></div>
        </div>
        <button class="btn btn-green" style="position:fixed; bottom:10px; left:15px; width:calc(100% - 30px); height: 50px;" onclick="exportExcel()">ðŸ’¾ SALVEAZÄ‚ EXCEL & TRIMITE</button>
    </div>

    <div class="overlay" id="overlay"></div>
    <div id="entry-popup" style="display:none;">
        <h4 id="pName" style="margin:0 0 10px 0;"></h4>
        <input type="number" id="pQty" placeholder="Cantitate" inputmode="decimal">
        <button class="btn btn-blue" onclick="confirmSave()">ADÄ‚UGÄ‚</button>
        <button class="btn" style="background:#eee" onclick="closePopup()">ÃŽNAPOI</button>
    </div>

<script>
    let db = []; let logs = []; let currentItem = null;

    function processExcel(input) {
        const reader = new FileReader();
        reader.onload = (e) => {
            const wb = XLSX.read(new Uint8Array(e.target.result), {type: 'array'});
            db = [];
            const container = document.getElementById('areaButtons');
            container.innerHTML = "";

            wb.SheetNames.forEach(name => {
                if(name.toLowerCase().includes("summary") || name.toLowerCase().includes("wastage")) return;
                
                // AdaugÄƒ buton pentru arie
                let b = document.createElement('button');
                b.className = 'btn btn-area';
                b.innerText = name;
                b.onclick = () => filterBySheet(name, b);
                container.appendChild(b);

                // Extrage datele
                let sheet = wb.Sheets[name];
                let rows = XLSX.utils.sheet_to_json(sheet, {header: 1, defval: ""});
                
                // CÄƒutÄƒm coloana cu numele produsului (cÄƒutÄƒm Ã®n primele 10 rÃ¢nduri rÃ¢ndul cu titluri)
                let headerIdx = 0;
                let prodCol = -1;
                let codeCol = -1;

                for(let i=0; i<Math.min(rows.length, 10); i++){
                    let row = rows[i];
                    for(let j=0; j<row.length; j++){
                        let val = String(row[j]).toUpperCase();
                        if(val.includes("PRODUCT") || val.includes("DESCRIPTION")) { prodCol = j; headerIdx = i; }
                        if(val.includes("CODE")) codeCol = j;
                    }
                    if(prodCol !== -1) break;
                }

                // DacÄƒ am gÄƒsit coloana, adÄƒugÄƒm datele
                if(prodCol !== -1) {
                    for(let k = headerIdx + 1; k < rows.length; k++){
                        let r = rows[k];
                        if(r[prodCol]) {
                            db.push({
                                code: codeCol !== -1 ? r[codeCol] : "N/A",
                                name: r[prodCol],
                                area: name
                            });
                        }
                    }
                }
            });
            document.getElementById('startBtn').style.display = 'block';
            alert("Gata! FiÈ™ierul a fost citit. ApasÄƒ butonul albastru.");
        };
        reader.readAsArrayBuffer(input.files[0]);
    }

    function showApp() { 
        document.getElementById('setup').style.display = 'none'; 
        document.getElementById('app').style.display = 'block'; 
    }

    function filterBySheet(name, btn) {
        document.querySelectorAll('.btn-area').forEach(x => x.classList.remove('area-active'));
        btn.classList.add('area-active');
        let filtered = db.filter(x => x.area === name);
        renderList(filtered);
    }

    function manualSearch() {
        let t = document.getElementById('search').value.toLowerCase();
        if(t.length < 2) return;
        renderList(db.filter(x => x.name.toLowerCase().includes(t)));
    }

    function renderList(items) {
        let div = document.getElementById('results');
        div.innerHTML = items.map(i => `
            <div class="res-item" onclick="askQty('${i.code}','${i.name.replace(/'/g,"")}','${i.area}')">
                <span><b>${i.name}</b><br><small>${i.area} | ${i.code}</small></span>
                <span style="color:#1a73e8; font-weight:bold;">+</span>
            </div>
        `).join('');
    }

    function askQty(code, name, area) {
        currentItem = { code, name, area };
        document.getElementById('pName').innerText = name;
        document.getElementById('overlay').style.display = 'block';
        document.getElementById('entry-popup').style.display = 'block';
        document.getElementById('pQty').focus();
    }

    function confirmSave() {
        let q = document.getElementById('pQty').value;
        if(!q) return;
        logs.push({
            Locatie: document.getElementById('loc').value,
            Arie: currentItem.area,
            Cod: currentItem.code,
            Produs: currentItem.name,
            Cantitate: q
        });
        closePopup();
        alert("Salvat: " + currentItem.name);
    }

    function closePopup() {
        document.getElementById('overlay').style.display = 'none';
        document.getElementById('entry-popup').style.display = 'none';
        document.getElementById('pQty').value = "";
    }

    function exportExcel() {
        if(logs.length === 0) return alert("Nu ai salvat nimic!");
        const ws = XLSX.utils.json_to_sheet(logs);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, "Rezultat");
        XLSX.writeFile(wb, "Stoc_Final.xlsx");
    }
</script>
</body>
</html>
